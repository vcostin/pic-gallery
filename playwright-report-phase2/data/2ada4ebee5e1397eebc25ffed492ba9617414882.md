# Test info

- Name: Authentication UI Elements >> should show error on invalid credentials
- Location: /Users/vcostin/Work/pic-gallery/e2e-tests/auth.spec.ts:116:7

# Error details

```
Error: page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/auth/login
Call log:
  - navigating to "http://localhost:3000/auth/login", waiting until "load"

    at /Users/vcostin/Work/pic-gallery/e2e-tests/auth.spec.ts:117:16
```

# Test source

```ts
   17 |   test('should test complete user lifecycle: registration, login, account deletion, and login attempt after deletion', async ({ page }: { page: Page }) => {
   18 |     // Skip in authenticated project as it conflicts with pre-authenticated state
   19 |     if (process.env.AUTH_ONLY) {
   20 |       console.log('Skipping user lifecycle test in authenticated project');
   21 |       return;
   22 |     }
   23 |     
   24 |     // 1. Create a new account with generated credentials
   25 |     await page.goto(registerUrl);
   26 |     await expect(page).toHaveURL(registerUrl);
   27 |
   28 |     await page.getByTestId('register-name').fill(userName);
   29 |     await page.getByTestId('register-email').fill(userEmail);
   30 |     await page.getByTestId('register-password').fill(userPassword);
   31 |     await page.getByTestId('register-confirm-password').fill(userPassword);
   32 |     await page.getByTestId('register-submit').click();
   33 |
   34 |     // Wait for the registration process to complete (redirect to login or home)
   35 |     await page.waitForURL((urlObject: URL) => urlObject.pathname === loginUrl || urlObject.pathname === '/', { timeout: 10000 });
   36 |
   37 |     // 1.1. If automatically logged in after registration, then logout
   38 |     const logoutButton = page.getByTestId('logout-button');
   39 |     const isLoggedIn = await logoutButton.isVisible({ timeout: 5000 }).catch(() => false);
   40 |
   41 |     if (isLoggedIn) {
   42 |       console.log('User was automatically logged in after registration, performing logout');
   43 |       await logoutButton.click();
   44 |       await expect(page).toHaveURL(loginUrl, { timeout: 10000 });
   45 |     } else {
   46 |       // If not automatically logged in, ensure we're on login page
   47 |       if (page.url().endsWith(loginUrl) === false && page.url().endsWith('/') === false) {
   48 |         await page.goto(loginUrl);
   49 |       }
   50 |     }
   51 |     await expect(page.url()).toMatch(new RegExp(`${loginUrl}$|/$`)); // Ensure on login or home page before proceeding
   52 |
   53 |     // 2. Login using previously created account credentials to verify they work
   54 |     if (!page.url().endsWith(loginUrl)) { // Ensure we are on login page
   55 |         await page.goto(loginUrl);
   56 |     }
   57 |     await expect(page).toHaveURL(loginUrl);
   58 |     
   59 |     // Fill in the credentials that were used for registration
   60 |     await page.getByTestId('login-email').fill(userEmail);
   61 |     await page.getByTestId('login-password').fill(userPassword);
   62 |     await page.getByTestId('login-submit').click();
   63 |
   64 |     // Verify successful login
   65 |     await expect(page.getByTestId('logout-button')).toBeVisible({ timeout: 10000 });
   66 |     await expect(page).not.toHaveURL(loginUrl, { timeout: 5000 });
   67 |
   68 |     // 3. Delete account through profile page
   69 |     await page.goto(profileUrl);
   70 |     await expect(page).toHaveURL(profileUrl);
   71 |
   72 |     // Trigger account deletion dialog
   73 |     await page.getByTestId('delete-account-button').click();
   74 |     
   75 |     // Confirm account deletion in the dialog
   76 |     // We need to type DELETE in the confirmation field
   77 |     await page.getByTestId('delete-confirmation-input').fill('DELETE');
   78 |     await page.getByTestId('confirm-delete-account').click();
   79 |
   80 |     // After deletion, user should be logged out and redirected to login page or home page
   81 |     await expect(page.getByTestId('logout-button')).not.toBeVisible({ timeout: 10000 });
   82 |     // The app might redirect to login page or home page after account deletion
   83 |     await expect(page).toHaveURL(new RegExp(`${loginUrl}|/`), { timeout: 10000 });
   84 |
   85 |     // 4. Try to login again with the same credentials to verify account has been deleted
   86 |     if (!page.url().endsWith(loginUrl)) { // Ensure we are on login page
   87 |         await page.goto(loginUrl);
   88 |     }
   89 |     await expect(page).toHaveURL(loginUrl);
   90 |     
   91 |     // Attempt login with the previously deleted account
   92 |     await page.getByTestId('login-email').fill(userEmail);
   93 |     await page.getByTestId('login-password').fill(userPassword);
   94 |     await page.getByTestId('login-submit').click();
   95 |
   96 |     // We expect login to fail with an error message
   97 |     const errorMessage = page.getByTestId('login-error');
   98 |     await expect(errorMessage).toBeVisible({ timeout: 5000 });
   99 |     await expect(errorMessage).toContainText(/invalid|incorrect|failed|not found|credentials/i);
  100 |     await expect(page).toHaveURL(loginUrl); // Should remain on login page
  101 |   });
  102 | });
  103 |
  104 | // Basic authentication UI tests (don't require account creation)
  105 | test.describe('Authentication UI Elements', () => {
  106 |   test('should display login form', async ({ page }: { page: Page }) => {
  107 |     await page.goto(loginUrl);
  108 |     
  109 |     // Check that the login form is displayed
  110 |     await expect(page.locator('form')).toBeVisible();
  111 |     await expect(page.getByTestId('login-email')).toBeVisible();
  112 |     await expect(page.getByTestId('login-password')).toBeVisible();
  113 |     await expect(page.getByTestId('login-submit')).toBeVisible();
  114 |   });
  115 |
  116 |   test('should show error on invalid credentials', async ({ page }: { page: Page }) => {
> 117 |     await page.goto(loginUrl);
      |                ^ Error: page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/auth/login
  118 |     
  119 |     // Fill in invalid credentials
  120 |     await page.getByTestId('login-email').fill('invalid@example.com');
  121 |     await page.getByTestId('login-password').fill('wrongpassword');
  122 |     
  123 |     // Click login button
  124 |     await page.getByTestId('login-submit').click();
  125 |     
  126 |     // Wait for the error message
  127 |     await expect(page.getByTestId('login-error')).toBeVisible();
  128 |     await expect(page.getByTestId('login-error')).toContainText(/invalid|incorrect|failed/i);
  129 |   });
  130 | });
  131 |
  132 | // Example of how to test protected routes
  133 | test.describe('Protected Routes', () => {
  134 |   test('should redirect unauthenticated users from protected pages', async ({ page }: { page: Page }) => {
  135 |     // Skip if running in the authenticated project (using AUTH_ONLY env var)
  136 |     if (process.env.AUTH_ONLY) {
  137 |       console.log('Skipping protected routes test in authenticated project');
  138 |       return;
  139 |     }
  140 |     
  141 |     // Try to access a protected page
  142 |     await page.goto('/profile');
  143 |     
  144 |     // Expect redirect to login
  145 |     await expect(page).toHaveURL(new RegExp(`${loginUrl}|/auth/error`)); // Updated to reflect potential redirect to error page too
  146 |   });
  147 | });
  148 |
```